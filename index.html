<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BxQuiz - Simple</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f0f4f8; color: #333; }
    .container { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
    h1, h2 { text-align: center; color: #2c3e50; }
    input, button { width: 100%; padding: 14px; margin: 10px 0; font-size: 1.1rem; border-radius: 8px; border: 1px solid #ccc; }
    button { background: #4CAF50; color: white; border: none; cursor: pointer; }
    button:disabled { background: #aaa; cursor: not-allowed; }
    .section { display: none; }
    .active { display: block; }
    #qr { text-align: center; margin: 30px 0; }
    .player { background: #e3f2fd; padding: 10px; margin: 8px 0; border-radius: 8px; }
    .error { color: red; text-align: center; font-weight: bold; }
  </style>
</head>
<body>

<div class="container">

  <!-- SecciÃ³n Login / Registro -->
  <div id="loginSection" class="section active">
    <h1>BxQuiz</h1>
    <input id="email" type="email" placeholder="Email" />
    <input id="password" type="password" placeholder="ContraseÃ±a" />
    <button onclick="login()">Iniciar sesiÃ³n</button>
    <button onclick="register()" style="background:#2196F3;">Registrarse</button>
    <p id="loginError" class="error"></p>
  </div>

  <!-- Dashboard -->
  <div id="dashboardSection" class="section">
    <h2>Bienvenido, <span id="userEmail"></span></h2>
    <button onclick="showCreateQuiz()">Crear Quiz</button>
    <button onclick="logout()" style="background:#f44336;">Cerrar sesiÃ³n</button>
  </div>

  <!-- Crear Quiz -->
  <div id="createQuizSection" class="section">
    <h2>Crear Quiz</h2>
    <input id="quizTitle" placeholder="TÃ­tulo del quiz" />
    <div id="questionsContainer"></div>
    <button onclick="addQuestion()">+ AÃ±adir pregunta</button>
    <button onclick="saveQuiz()" style="background:#673AB7;">Guardar y generar cÃ³digo</button>
    <p id="createError" class="error"></p>
    <div id="qr" style="display:none;">
      <h3>CÃ³digo: <span id="gameCode"></span></h3>
      <div id="qrcode"></div>
      <p><a id="joinLink" target="_blank">Enlace para jugadores</a></p>
    </div>
  </div>

  <!-- Lobby / Juego -->
  <div id="gameSection" class="section">
    <h2 id="gameTitle"></h2>
    <p>CÃ³digo: <strong id="currentCode"></strong></p>
    <div id="lobbyPlayers"></div>
    <div id="questionArea" style="display:none;">
      <h3 id="questionText"></h3>
      <div id="options"></div>
      <p id="feedback" style="font-weight:bold; font-size:1.3rem;"></p>
    </div>
    <button id="startBtn" onclick="startQuiz()" style="display:none; background:#4CAF50;">Empezar Quiz</button>
  </div>

</div>

<script>
// ================================================
// CONFIGURACIÃ“N FIREBASE (copia tu config real)
// ================================================
const firebaseConfig = {
  apiKey: "AIzaSyD13N4-9MjTrmlPwGP7mves0Exje4v2ACw",
  authDomain: "kahoot-8529e.firebaseapp.com",
  databaseURL: "https://kahoot-8529e-default-rtdb.firebaseio.com",
  projectId: "kahoot-8529e",
  storageBucket: "kahoot-8529e.firebasestorage.app",
  messagingSenderId: "313414356056",
  appId: "1:313414356056:web:4aab4587f7df9393008e2d",
  measurementId: "G-8T4CPC1BQ3"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const database = firebase.database();

// ================================================
// FUNCIONES DE AUTENTICACIÃ“N
// ================================================
function login() {
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;
  auth.signInWithEmailAndPassword(email, password)
    .then(user => showDashboard())
    .catch(err => document.getElementById('loginError').textContent = err.message);
}

function register() {
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;
  auth.createUserWithEmailAndPassword(email, password)
    .then(user => showDashboard())
    .catch(err => document.getElementById('loginError').textContent = err.message);
}

function logout() {
  auth.signOut().then(() => {
    showSection('loginSection');
  });
}

// ================================================
// NAVEGACIÃ“N ENTRE SECCIONES
// ================================================
function showSection(id) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function showDashboard() {
  document.getElementById('userEmail').textContent = auth.currentUser.email;
  showSection('dashboardSection');
}

function showCreateQuiz() {
  showSection('createQuizSection');
  // Limpiar formulario
  document.getElementById('quizTitle').value = '';
  document.getElementById('questionsContainer').innerHTML = '';
  addQuestion(); // AÃ±ade la primera pregunta
}

// ================================================
// CREAR QUIZ
// ================================================
let questionCount = 0;

function addQuestion() {
  questionCount++;
  const container = document.getElementById('questionsContainer');
  const div = document.createElement('div');
  div.innerHTML = `
    <h4>Pregunta ${questionCount}</h4>
    <input id="q${questionCount}" placeholder="Escribe la pregunta" style="width:100%; padding:10px; margin-bottom:10px;" />
    <div>
      <input id="q${questionCount}_1" placeholder="OpciÃ³n 1" style="width:80%; padding:8px;" />
      <input type="radio" name="correct${questionCount}" value="0" />
    </div>
    <div>
      <input id="q${questionCount}_2" placeholder="OpciÃ³n 2" style="width:80%; padding:8px;" />
      <input type="radio" name="correct${questionCount}" value="1" />
    </div>
    <div>
      <input id="q${questionCount}_3" placeholder="OpciÃ³n 3" style="width:80%; padding:8px;" />
      <input type="radio" name="correct${questionCount}" value="2" />
    </div>
    <div>
      <input id="q${questionCount}_4" placeholder="OpciÃ³n 4" style="width:80%; padding:8px;" />
      <input type="radio" name="correct${questionCount}" value="3" />
    </div>
  `;
  container.appendChild(div);
}

function saveQuiz() {
  const title = document.getElementById('quizTitle').value.trim();
  if (!title) return alert('Pon un tÃ­tulo');

  const questions = [];
  for (let i = 1; i <= questionCount; i++) {
    const q = document.getElementById(`q${i}`).value.trim();
    const opts = [];
    for (let j = 1; j <= 4; j++) {
      const opt = document.getElementById(`q${i}_${j}`).value.trim();
      if (opt) opts.push(opt);
    }
    const correct = document.querySelector(`input[name="correct${i}"]:checked`);
    if (!q || opts.length < 2 || !correct) return alert('Completa todas las preguntas correctamente');
    questions.push({ question: q, options: opts, correct: parseInt(correct.value) });
  }

  const code = Math.random().toString(36).substring(2, 8).toUpperCase();

  database.ref(`games/${code}`).set({
    title,
    creator: auth.currentUser.uid,
    creatorEmail: auth.currentUser.email,
    questions,
    createdAt: Date.now(),
    players: {},
    currentQuestion: -1,
    started: false,
    ended: false
  }).then(() => {
    document.getElementById('gameCode').textContent = code;
    const joinLink = `${window.location.origin}${window.location.pathname}?code=${code}`;
    document.getElementById('joinLink').href = joinLink;
    document.getElementById('joinLink').textContent = joinLink;
    document.getElementById('qr').style.display = 'block';

    new QRCode(document.getElementById("qrcode"), {
      text: joinLink,
      width: 256,
      height: 256
    });

    // Escuchar jugadores
    database.ref(`games/${code}/players`).on('value', snap => {
      const playersDiv = document.getElementById('lobbyPlayers') || document.createElement('div');
      playersDiv.innerHTML = '<h3>Jugadores conectados:</h3>';
      snap.forEach(child => {
        const p = child.val();
        playersDiv.innerHTML += `<div class="player">${p.email || 'AnÃ³nimo'}</div>`;
      });
    });
  }).catch(err => alert('Error: ' + err.message));
}

// ================================================
// LÃ“GICA PARA UNIRSE Y JUGAR (si hay ?code= en la URL)
// ================================================
window.onload = () => {
  auth.onAuthStateChanged(user => {
    if (user) {
      document.getElementById('userEmail').textContent = user.email;
      showDashboard();
    } else {
      showSection('loginSection');
    }
  });

  // Si hay cÃ³digo en la URL â†’ modo join/juego
  const urlParams = new URLSearchParams(window.location.search);
  const code = urlParams.get('code');
  if (code) {
    joinGame(code);
  }
};

function joinGame(code) {
  showSection('gameSection');
  document.getElementById('currentCode').textContent = code;

  const gameRef = database.ref(`games/${code}`);

  gameRef.once('value', snap => {
    const game = snap.val();
    if (!game) return alert('Quiz no encontrado');
    document.getElementById('gameTitle').textContent = game.title;

    // AÃ±adir jugador
    const playerRef = database.ref(`games/${code}/players/${auth.currentUser.uid}`);
    playerRef.set({
      uid: auth.currentUser.uid,
      email: auth.currentUser.email,
      score: 0,
      answered: false,
      joinedAt: Date.now()
    });

    // Escuchar cambios
    gameRef.on('value', snap => {
      const g = snap.val();
      if (!g) return;

      // Lobby
      const playersDiv = document.getElementById('lobbyPlayers');
      playersDiv.innerHTML = '<h3>Jugadores:</h3>';
      Object.values(g.players || {}).forEach(p => {
        playersDiv.innerHTML += `<div class="player">${p.email} ${p.uid === g.creator ? 'ðŸ‘‘' : ''}</div>`;
      });

      if (g.started) {
        document.getElementById('lobbyPlayers').style.display = 'none';
        document.getElementById('questionArea').style.display = 'block';
        showQuestion(g);
      }
    });
  });
}

function showQuestion(game) {
  const index = game.currentQuestion;
  if (index < 0 || index >= game.questions.length) return;

  const q = game.questions[index];
  document.getElementById('questionText').textContent = q.question;

  const optionsDiv = document.getElementById('options');
  optionsDiv.innerHTML = '';
  q.options.forEach((opt, i) => {
    const btn = document.createElement('button');
    btn.textContent = opt;
    btn.style = 'width:100%; padding:14px; margin:8px 0; font-size:1.2rem; background:#e0e0e0; border:none; border-radius:8px; cursor:pointer;';
    btn.onclick = () => submitAnswer(game, index, i);
    optionsDiv.appendChild(btn);
  });
}

function submitAnswer(game, qIndex, optionIndex) {
  const q = game.questions[qIndex];
  const isCorrect = optionIndex === q.correct;

  database.ref(`games/${game.code}/players/${auth.currentUser.uid}`).update({
    score: firebase.database.ServerValue.increment(isCorrect ? 10 : 0),
    answered: true,
    lastCorrect: isCorrect
  });

  document.getElementById('feedback').textContent = isCorrect ? 'Â¡Correcto! +10' : 'Incorrecto';
  document.getElementById('feedback').style.color = isCorrect ? '#4CAF50' : '#f44336';
}
</script>
</body>
</html>
