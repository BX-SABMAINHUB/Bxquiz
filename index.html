<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BxQuiz</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  
  <style>
    :root {
      --primary: #6b46c1;
      --secondary: #38b2ac;
      --success: #48bb78;
      --danger: #f56565;
    }
    body { 
      margin: 0; 
      font-family: 'Segoe UI', sans-serif; 
      background: linear-gradient(135deg, #667eea, #764ba2); 
      color: white; 
      min-height: 100vh;
    }
    .container { 
      max-width: 700px; 
      margin: 0 auto; 
      padding: 20px; 
    }
    .card { 
      background: white; 
      color: #2d3748; 
      border-radius: 20px; 
      padding: 30px; 
      box-shadow: 0 20px 40px rgba(0,0,0,0.2); 
      margin: 20px 0;
    }
    input, button { 
      width: 100%; 
      padding: 16px; 
      margin: 10px 0; 
      border-radius: 12px; 
      border: none; 
      font-size: 1.1rem; 
    }
    input { background: #f7fafc; border: 2px solid #e2e8f0; }
    button { 
      background: var(--primary); 
      color: white; 
      font-weight: bold; 
      cursor: pointer; 
      transition: 0.3s; 
    }
    button:hover { transform: scale(1.05); }
    .btn-green { background: var(--success); }
    .btn-red { background: var(--danger); }
    .hidden { display: none !important; }
    .qr { text-align: center; margin: 30px 0; }
    .player { 
      background: #f0fff4; 
      padding: 12px; 
      margin: 8px 0; 
      border-radius: 12px; 
      font-size: 1.1rem; 
    }
    .shop-item { 
      background: #f7fafc; 
      padding: 20px; 
      border-radius: 16px; 
      text-align: center; 
      margin: 15px 0; 
      cursor: pointer; 
      transition: 0.3s; 
    }
    .shop-item:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
    .roulette { 
      width: 300px; 
      height: 300px; 
      border-radius: 50%; 
      border: 15px solid #2d3748; 
      margin: 30px auto; 
      position: relative; 
      overflow: hidden; 
    }
    .roulette-wheel { 
      width: 100%; 
      height: 100%; 
      border-radius: 50%; 
      transition: transform 4s cubic-bezier(0.25, 0.1, 0.25, 1); 
    }
    .option { 
      position: absolute; 
      width: 50%; 
      height: 50%; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      font-weight: bold; 
      color: white; 
      text-align: center; 
      padding: 10px; 
    }
  </style>
</head>
<body>

<div class="container">

  <!-- LOGIN -->
  <div id="loginScreen" class="card">
    <h1 style="color:#6b46c1">BxQuiz</h1>
    <input id="email" type="email" placeholder="Email" />
    <input id="password" type="password" placeholder="Contraseña" />
    <button onclick="login()">Iniciar Sesión</button>
    <button onclick="register()" class="btn-green">Registrarse</button>
    <p id="authError" style="color:red; text-align:center;"></p>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboardScreen" class="card hidden">
    <h2>Bienvenido, <span id="userEmail"></span></h2>
    <button onclick="showCreateQuiz()" style="background:#6b46c1">Crear Quiz</button>
    <button onclick="showJoinScreen()" style="background:#38b2ac">Unirse por Código</button>
    <button onclick="showShop()" style="background:#ed8936">Tienda de Sobres</button>
    <button onclick="logout()" class="btn-red">Cerrar Sesión</button>
  </div>

  <!-- CREAR QUIZ -->
  <div id="createQuizScreen" class="card hidden">
    <h2>Crear Nuevo Quiz</h2>
    <input id="quizTitle" placeholder="Título del Quiz" />
    <div id="questionsList"></div>
    <button onclick="addQuestionField()">+ Añadir Pregunta</button>
    <button onclick="saveQuiz()" style="background:#48bb78">Guardar y Generar Código</button>
    <p id="createError" style="color:red"></p>
    
    <div id="quizCreated" class="hidden">
      <h3>Código: <span id="generatedCode" style="color:#e53e3e; font-size:2rem"></span></h3>
      <div id="qrcode" class="qr"></div>
      <p><strong>Enlace:</strong> <span id="joinLinkText"></span></p>
    </div>
  </div>

  <!-- JOIN / LOBBY -->
  <div id="joinScreen" class="card hidden">
    <h2>Unirse a Quiz</h2>
    <input id="joinCode" placeholder="Código del Quiz" maxlength="6" style="text-transform:uppercase" />
    <button onclick="joinQuiz()">Unirse</button>
    <p id="joinError" style="color:red"></p>
  </div>

  <!-- LOBBY -->
  <div id="lobbyScreen" class="card hidden">
    <h2>Lobby - Código: <span id="lobbyCode"></span></h2>
    <h3>Jugadores conectados (<span id="playerCount">0</span>)</h3>
    <div id="playerList"></div>
    <button id="startButton" onclick="startGame()" class="hidden" style="background:#38b2ac; margin-top:30px">Empezar Quiz</button>
  </div>

  <!-- JUEGO -->
  <div id="gameScreen" class="card hidden">
    <h3 id="questionNumber"></h3>
    <h2 id="currentQuestion"></h2>
    <div id="options" style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:30px"></div>
    <p id="gameFeedback" style="margin-top:30px; font-size:1.4rem; font-weight:bold"></p>
  </div>

  <!-- TIENDA -->
  <div id="shopScreen" class="card hidden">
    <h2>Tienda de Sobres</h2>
    <p>Monedas: <strong id="userCoins">0</strong></p>
    
    <div class="shop-item" onclick="buyPack(1)">
      <h3>Sobre Normal</h3>
      <p>10 monedas</p>
    </div>
    <div class="shop-item" onclick="buyPack(2)">
      <h3>Sobre Raro</h3>
      <p>25 monedas</p>
    </div>
    <div class="shop-item" onclick="buyPack(3)">
      <h3>Sobre Épico</h3>
      <p>50 monedas</p>
    </div>
  </div>

  <!-- RULETA -->
  <div id="rouletteScreen" class="card hidden">
    <h2>Ruleta Diaria (cada 5 horas)</h2>
    <div class="roulette" onclick="spinRoulette()">
      <div id="rouletteWheel" class="roulette-wheel"></div>
    </div>
    <p id="rouletteResult" style="font-size:1.8rem; margin-top:20px"></p>
  </div>

</div>

<script>
// ================== FIREBASE CONFIG ==================
const firebaseConfig = {
  apiKey: "AIzaSyD13N4-9MjTrmlPwGP7mves0Exje4v2ACw",
  authDomain: "kahoot-8529e.firebaseapp.com",
  databaseURL: "https://kahoot-8529e-default-rtdb.firebaseio.com",
  projectId: "kahoot-8529e",
  storageBucket: "kahoot-8529e.firebasestorage.app",
  messagingSenderId: "313414356056",
  appId: "1:313414356056:web:4aab4587f7df9393008e2d"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

// ================== VARIABLES GLOBALES ==================
let currentGameCode = null;
let isCreator = false;

// ================== FUNCIONES DE AUTENTICACIÓN ==================
function login() {
  const email = document.getElementById('email').value;
  const pass = document.getElementById('password').value;
  auth.signInWithEmailAndPassword(email, pass)
    .then(() => showScreen('dashboardScreen'))
    .catch(err => document.getElementById('authError').textContent = err.message);
}

function register() {
  const email = document.getElementById('email').value;
  const pass = document.getElementById('password').value;
  auth.createUserWithEmailAndPassword(email, pass)
    .then(() => showScreen('dashboardScreen'))
    .catch(err => document.getElementById('authError').textContent = err.message);
}

function logout() {
  auth.signOut().then(() => showScreen('loginScreen'));
}

// ================== NAVEGACIÓN ==================
function showScreen(screenId) {
  document.querySelectorAll('.card').forEach(c => c.classList.add('hidden'));
  document.getElementById(screenId).classList.remove('hidden');
}

// ================== DASHBOARD ==================
auth.onAuthStateChanged(user => {
  if (user) {
    document.getElementById('userEmail').textContent = user.email;
    showScreen('dashboardScreen');
  } else {
    showScreen('loginScreen');
  }
});

// ================== CREAR QUIZ ==================
function showCreateQuiz() {
  showScreen('createQuizScreen');
  document.getElementById('questionsList').innerHTML = '';
  addQuestionField();
}

function addQuestionField() {
  const container = document.getElementById('questionsList');
  const index = container.children.length + 1;
  const div = document.createElement('div');
  div.innerHTML = `
    <h4>Pregunta ${index}</h4>
    <input id="q${index}" placeholder="Pregunta" style="width:100%; padding:10px; margin:5px 0" />
    <input id="o${index}_1" placeholder="Opción 1" style="width:48%; padding:8px; margin:5px" />
    <input id="o${index}_2" placeholder="Opción 2" style="width:48%; padding:8px; margin:5px" />
    <input id="o${index}_3" placeholder="Opción 3" style="width:48%; padding:8px; margin:5px" />
    <input id="o${index}_4" placeholder="Opción 4" style="width:48%; padding:8px; margin:5px" />
    <p>Respuesta correcta: 
      <select id="correct${index}">
        <option value="0">Opción 1</option>
        <option value="1">Opción 2</option>
        <option value="2">Opción 3</option>
        <option value="3">Opción 4</option>
      </select>
    </p>
  `;
  container.appendChild(div);
}

function saveQuiz() {
  const title = document.getElementById('quizTitle').value.trim();
  if (!title) return alert('Pon un título');

  const questions = [];
  const container = document.getElementById('questionsList');
  for (let i = 0; i < container.children.length; i++) {
    const q = document.getElementById(`q${i+1}`).value.trim();
    const opts = [
      document.getElementById(`o${i+1}_1`).value.trim(),
      document.getElementById(`o${i+1}_2`).value.trim(),
      document.getElementById(`o${i+1}_3`).value.trim(),
      document.getElementById(`o${i+1}_4`).value.trim()
    ];
    const correct = parseInt(document.getElementById(`correct${i+1}`).value);
    if (!q || opts.some(o => !o)) return alert('Completa todas las preguntas');
    questions.push({ question: q, options: opts, correct });
  }

  const gameCode = Math.random().toString(36).substring(2, 8).toUpperCase();

  db.ref(`games/${gameCode}`).set({
    title,
    creator: auth.currentUser.uid,
    creatorEmail: auth.currentUser.email,
    questions,
    createdAt: Date.now(),
    players: {},
    currentQuestion: -1,
    started: false,
    ended: false
  }).then(() => {
    document.getElementById('generatedCode').textContent = gameCode;
    const link = `${window.location.origin}${window.location.pathname}?code=${gameCode}`;
    document.getElementById('joinLinkText').textContent = link;
    document.getElementById('quizCreated').classList.remove('hidden');

    new QRCode(document.getElementById("qrcode"), {
      text: link,
      width: 256,
      height: 256
    });
  });
}

// ================== UNIRSE ==================
function showJoinScreen() {
  showScreen('joinScreen');
}

function joinQuiz() {
  const code = document.getElementById('joinCode').value.trim().toUpperCase();
  if (!code) return alert('Pon un código');

  db.ref(`games/${code}`).once('value', snap => {
    const game = snap.val();
    if (!game) return alert('Código inválido');

    db.ref(`games/${code}/players/${auth.currentUser.uid}`).set({
      uid: auth.currentUser.uid,
      email: auth.currentUser.email,
      score: 0,
      answered: false,
      joinedAt: Date.now()
    }).then(() => {
      window.location.href = `?code=${code}`;
    });
  });
}

// ================== LOBBY Y JUEGO ==================
function checkForCodeInURL() {
  const params = new URLSearchParams(window.location.search);
  const code = params.get('code');
  if (code) {
    currentGameCode = code;
    showScreen('lobbyScreen');
    document.getElementById('lobbyCode').textContent = code;

    db.ref(`games/${code}`).on('value', snap => {
      const game = snap.val();
      if (!game) return;

      const list = document.getElementById('playerList');
      list.innerHTML = '';
      Object.values(game.players || {}).forEach(p => {
        const div = document.createElement('div');
        div.className = 'player';
        div.textContent = p.email || 'Jugador';
        list.appendChild(div);
      });

      if (game.started) {
        startGameForAll();
      }
    });
  }
}

function startGame() {
  if (!currentGameCode) return;
  db.ref(`games/${currentGameCode}`).update({ started: true, currentQuestion: 0 });
}

function startGameForAll() {
  showScreen('gameScreen');
  // Aquí iría la lógica del juego (simplificada por ahora)
  alert('¡El quiz ha empezado! (Versión simplificada)');
}

// ================== TIENDA Y RULETA ==================
function showShop() {
  showScreen('shopScreen');
  // Aquí puedes expandir la tienda más adelante
}

function buyPack(price) {
  alert(`Compraste un sobre por ${price} monedas (animación en desarrollo)`);
}

function showRoulette() {
  showScreen('rouletteScreen');
}

function spinRoulette() {
  const prizes = [0,0,0,0,0,0,0,0,0,5,5,1000];
  const result = prizes[Math.floor(Math.random() * prizes.length)];
  document.getElementById('rouletteResult').textContent = result === 0 ? '¡Nada!' : `¡Ganaste ${result} monedas!`;
}

// Inicializar
window.onload = () => {
  checkForCodeInURL();
};
</script>
</body>
</html>
