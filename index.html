<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BxQuiz - Kahoot Ultra Profesional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.4/howler.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;family=Space+Grotesk:wght@500;600;700&amp;display=swap');
        
        :root {
            --primary: 168 85 247;
        }
        
        .tail-container {
            font-family: 'Inter', system_ui, sans-serif;
        }
        
        .logo-font {
            font-family: 'Space Grotesk', sans-serif;
        }

        .glass {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
        }

        .screen {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .option-btn {
            transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        }
        
        .option-btn:hover {
            transform: scale(1.04) translateY(-4px);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.2);
        }
        
        .option-btn:active {
            transform: scale(0.95);
        }

        .timer-bar {
            transition: width 1s linear;
        }

        .spin-wheel {
            transition: transform 6s cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        .modal {
            animation: modalPop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        @keyframes modalPop {
            0% { transform: scale(0.6) translateY(40px); opacity: 0; }
            100% { transform: scale(1) translateY(0); opacity: 1; }
        }

        .coin {
            display: inline-block;
            animation: coinFloat 3s ease-in-out infinite;
        }

        @keyframes coinFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-12px); }
        }

        .question-text {
            text-shadow: 0 4px 20px rgba(0, 0, 0, 0.6);
        }

        /* ============================================= */
        /* ANIMACIONES DE FEEDBACK CORRECTO / INCORRECTO */
        /* ============================================= */
        .correct-answer {
            animation: correctPop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) !important;
            box-shadow: 0 0 60px #22c55e !important;
        }
        @keyframes correctPop {
            0% { transform: scale(0.95); }
            40% { transform: scale(1.18); }
            70% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .wrong-answer {
            animation: wrongShake 0.7s ease !important;
            box-shadow: 0 0 60px #ef4444 !important;
        }
        @keyframes wrongShake {
            0%, 100% { transform: translateX(0) scale(1); }
            15% { transform: translateX(-18px) scale(0.96); }
            30% { transform: translateX(18px) scale(0.96); }
            45% { transform: translateX(-12px) scale(0.97); }
            60% { transform: translateX(12px) scale(0.97); }
            75% { transform: translateX(-6px) scale(0.98); }
            90% { transform: translateX(6px) scale(0.98); }
        }

        .feedback-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 5rem;
            font-weight: 900;
            z-index: 9999;
            pointer-events: none;
            text-shadow: 0 0 40px currentColor;
            animation: feedbackFade 1.8s forwards;
        }
        @keyframes feedbackFade {
            0% { opacity: 0; transform: translate(-50%, -70%) scale(0.6); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.05); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -30%) scale(0.9); }
        }
    </style>
</head>
<body class="tail-container bg-zinc-950 text-white overflow-hidden min-h-screen">
    <div id="app" class="min-h-screen flex flex-col">
        <!-- HEADER GLOBAL -->
        <header id="global-header" class="hidden bg-zinc-900 border-b border-white/10 py-4 px-6 flex items-center justify-between z-50">
            <div class="flex items-center gap-x-3">
                <div class="w-9 h-9 bg-gradient-to-br from-violet-500 to-fuchsia-500 rounded-2xl flex items-center justify-center text-white font-bold text-2xl logo-font">B</div>
                <div>
                    <span class="text-2xl font-bold tracking-tighter logo-font text-white">Bx</span>
                    <span class="text-2xl font-bold tracking-tighter logo-font bg-gradient-to-r from-violet-400 to-fuchsia-400 bg-clip-text text-transparent">Quiz</span>
                </div>
            </div>
            
            <div class="flex items-center gap-x-8">
                <!-- User info -->
                <div id="user-header-info" class="flex items-center gap-x-3 cursor-pointer" onclick="showAvatarsScreen()">
                    <img id="header-avatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Default" alt="Avatar" class="w-9 h-9 rounded-2xl ring-2 ring-violet-500">
                    <div>
                        <p id="header-name" class="font-semibold text-sm">Usuario</p>
                        <div class="flex items-center gap-x-1 text-amber-400 text-xs">
                            <i class="fa-solid fa-coins"></i>
                            <span id="header-coins" class="font-bold">0</span>
                        </div>
                    </div>
                </div>

                <button onclick="logout()" 
                        class="px-5 py-2.5 bg-white/10 hover:bg-white/15 transition-colors rounded-3xl text-sm font-medium flex items-center gap-x-2">
                    <i class="fa-solid fa-right-from-bracket"></i>
                    <span>Salir</span>
                </button>
            </div>
        </header>

        <!-- LOGIN SCREEN -->
        <div id="login-screen" class="screen flex min-h-screen items-center justify-center bg-gradient-to-br from-zinc-950 via-violet-950 to-fuchsia-950">
            <div class="max-w-md w-full mx-4">
                <div class="glass border border-white/10 rounded-3xl p-10 shadow-2xl">
                    <div class="flex justify-center mb-8">
                        <div class="w-20 h-20 bg-gradient-to-br from-violet-500 to-fuchsia-500 rounded-3xl flex items-center justify-center text-5xl shadow-inner">üéÆ</div>
                    </div>
                    <h1 class="text-5xl font-bold text-center logo-font tracking-tighter mb-2">BxQuiz</h1>
                    <p class="text-center text-zinc-400 mb-10">El Kahoot m√°s profesional del mundo</p>
                    
                    <!-- Tabs -->
                    <div class="flex bg-zinc-900 rounded-3xl p-1 mb-8">
                        <button onclick="switchAuthTab(0)" id="tab-login" 
                                class="flex-1 py-4 text-sm font-semibold rounded-3xl transition-all tab-active">Iniciar Sesi√≥n</button>
                        <button onclick="switchAuthTab(1)" id="tab-register" 
                                class="flex-1 py-4 text-sm font-semibold rounded-3xl transition-all">Registrarse</button>
                    </div>

                    <!-- LOGIN FORM -->
                    <div id="login-form">
                        <div class="space-y-6">
                            <div>
                                <label class="block text-xs font-medium text-zinc-400 mb-2 tracking-widest">EMAIL</label>
                                <input id="login-email" type="email" 
                                       class="w-full bg-zinc-900 border border-white/10 focus:border-violet-500 rounded-3xl px-6 py-5 outline-none text-white placeholder-zinc-500"
                                       placeholder="tu@email.com">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-zinc-400 mb-2 tracking-widest">CONTRASE√ëA</label>
                                <input id="login-password" type="password" 
                                       class="w-full bg-zinc-900 border border-white/10 focus:border-violet-500 rounded-3xl px-6 py-5 outline-none text-white placeholder-zinc-500"
                                       placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                            </div>
                            <button onclick="loginUser()" 
                                    class="w-full py-6 bg-gradient-to-r from-violet-500 to-fuchsia-500 hover:from-violet-600 hover:to-fuchsia-600 transition-all rounded-3xl font-bold text-lg shadow-lg shadow-violet-500/50">
                                INICIAR SESI√ìN
                            </button>
                        </div>
                    </div>

                    <!-- REGISTER FORM -->
                    <div id="register-form" class="hidden">
                        <div class="space-y-6">
                            <div>
                                <label class="block text-xs font-medium text-zinc-400 mb-2 tracking-widest">EMAIL</label>
                                <input id="register-email" type="email" 
                                       class="w-full bg-zinc-900 border border-white/10 focus:border-violet-500 rounded-3xl px-6 py-5 outline-none text-white placeholder-zinc-500"
                                       placeholder="tu@email.com">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-zinc-400 mb-2 tracking-widest">CONTRASE√ëA</label>
                                <input id="register-password" type="password" 
                                       class="w-full bg-zinc-900 border border-white/10 focus:border-violet-500 rounded-3xl px-6 py-5 outline-none text-white placeholder-zinc-500"
                                       placeholder="M√≠nimo 6 caracteres">
                            </div>
                            <button onclick="registerUser()" 
                                    class="w-full py-6 bg-gradient-to-r from-violet-500 to-fuchsia-500 hover:from-violet-600 hover:to-fuchsia-600 transition-all rounded-3xl font-bold text-lg shadow-lg shadow-violet-500/50">
                                CREAR CUENTA GRATIS
                            </button>
                        </div>
                    </div>

                    <div id="auth-error" class="mt-6 text-red-400 text-center text-sm hidden"></div>

                    <div class="text-center mt-8 text-xs text-zinc-500">
                        Demo con Firebase Realtime DB ‚Ä¢ 100% funcional
                    </div>
                </div>
            </div>
        </div>

        <!-- DASHBOARD SCREEN -->
        <div id="dashboard-screen" class="screen hidden min-h-screen bg-zinc-950">
            <div class="max-w-7xl mx-auto px-6 py-8">
                <!-- Welcome -->
                <div class="flex justify-between items-end mb-12">
                    <div>
                        <h1 id="welcome-name" class="text-6xl font-bold logo-font tracking-tighter">¬°Hola, Jugador!</h1>
                        <p class="text-zinc-400 mt-3 text-xl">¬øListo para dominar el quiz?</p>
                    </div>
                    <div class="flex items-center gap-x-6">
                        <!-- Coins big -->
                        <div onclick="showShopScreen()" 
                             class="glass border border-amber-400/30 rounded-3xl px-8 py-5 flex items-center gap-x-4 cursor-pointer hover:border-amber-400 transition-all group">
                            <i class="fa-solid fa-coins text-4xl text-amber-400 group-active:scale-110 transition-transform"></i>
                            <div>
                                <div class="text-xs text-amber-300 tracking-widest font-medium">MONEDAS</div>
                                <div id="dash-coins" class="text-5xl font-bold text-amber-400">2450</div>
                            </div>
                        </div>
                        
                        <!-- Daily roulette -->
                        <button onclick="showRouletteScreen()" 
                                class="glass border border-white/10 hover:border-rose-400 transition-all rounded-3xl px-7 py-5 flex flex-col items-center justify-center gap-y-1">
                            <i class="fa-solid fa-wheelchair-move text-3xl"></i>
                            <span class="text-xs font-medium">Ruleta Diaria</span>
                        </button>
                    </div>
                </div>

                <!-- Main actions grid -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-6">
                    <!-- Crear Quiz -->
                    <div onclick="showCreateQuizScreen()" 
                         class="glass border border-white/10 hover:border-violet-400 h-80 rounded-3xl p-8 flex flex-col justify-between group cursor-pointer transition-all">
                        <div>
                            <div class="w-14 h-14 bg-violet-500/10 text-violet-400 rounded-2xl flex items-center justify-center text-4xl mb-6 group-hover:rotate-12 transition-transform">üìù</div>
                            <h3 class="text-3xl font-semibold mb-2">Crear Quiz</h3>
                            <p class="text-zinc-400">Crea tu propio juego y comparte el c√≥digo</p>
                        </div>
                        <div class="text-violet-400 text-sm font-medium flex items-center gap-x-2">
                            EMPEZAR <i class="fa-solid fa-arrow-right"></i>
                        </div>
                    </div>

                    <!-- Unirse por C√≥digo -->
                    <div onclick="showJoinScreen()" 
                         class="glass border border-white/10 hover:border-emerald-400 h-80 rounded-3xl p-8 flex flex-col justify-between group cursor-pointer transition-all">
                        <div>
                            <div class="w-14 h-14 bg-emerald-500/10 text-emerald-400 rounded-2xl flex items-center justify-center text-4xl mb-6 group-hover:scale-110 transition-transform">üî¢</div>
                            <h3 class="text-3xl font-semibold mb-2">Unirse por C√≥digo</h3>
                            <p class="text-zinc-400">Ingresa el c√≥digo de 6 d√≠gitos</p>
                        </div>
                        <div class="text-emerald-400 text-sm font-medium flex items-center gap-x-2">
                            UNIRME <i class="fa-solid fa-arrow-right"></i>
                        </div>
                    </div>

                    <!-- Escanear QR -->
                    <div onclick="showQRScanScreen()" 
                         class="glass border border-white/10 hover:border-cyan-400 h-80 rounded-3xl p-8 flex flex-col justify-between group cursor-pointer transition-all">
                        <div>
                            <div class="w-14 h-14 bg-cyan-500/10 text-cyan-400 rounded-2xl flex items-center justify-center text-4xl mb-6 group-hover:rotate-6 transition-transform">üì±</div>
                            <h3 class="text-3xl font-semibold mb-2">Escanear QR</h3>
                            <p class="text-zinc-400">Apunta a un c√≥digo QR</p>
                        </div>
                        <div class="text-cyan-400 text-sm font-medium flex items-center gap-x-2">
                            ESCANEAR <i class="fa-solid fa-arrow-right"></i>
                        </div>
                    </div>

                    <!-- Tienda & Avatares -->
                    <div class="grid grid-rows-2 gap-6">
                        <div onclick="showShopScreen()" 
                             class="glass border border-white/10 hover:border-amber-400 h-full rounded-3xl p-8 flex flex-col justify-center items-center cursor-pointer transition-all">
                            <i class="fa-solid fa-store text-5xl mb-4 text-amber-400"></i>
                            <h3 class="font-semibold text-2xl">Tienda</h3>
                            <p class="text-xs text-amber-300">Sobres y m√°s</p>
                        </div>
                        <div onclick="showAvatarsScreen()" 
                             class="glass border border-white/10 hover:border-pink-400 h-full rounded-3xl p-8 flex flex-col justify-center items-center cursor-pointer transition-all">
                            <i class="fa-solid fa-user-astronaut text-5xl mb-4 text-pink-400"></i>
                            <h3 class="font-semibold text-2xl">Avatares</h3>
                            <p class="text-xs text-pink-300">15 exclusivos</p>
                        </div>
                    </div>
                </div>

                <!-- Recent quizzes -->
                <div class="mt-16">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-semibold">Tus quizzes recientes</h2>
                        <button onclick="showCreateQuizScreen()" 
                                class="text-violet-400 text-sm flex items-center gap-x-2 hover:text-violet-300">
                            <i class="fa-solid fa-plus"></i> NUEVO QUIZ
                        </button>
                    </div>
                    <div id="recent-quizzes" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- populated by JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- CREATE QUIZ SCREEN -->
        <div id="create-quiz-screen" class="screen hidden min-h-screen bg-zinc-950">
            <div class="max-w-5xl mx-auto px-6 py-10">
                <div class="flex items-center justify-between mb-10">
                    <button onclick="showDashboard()" 
                            class="flex items-center gap-x-3 text-zinc-400 hover:text-white transition-colors">
                        <i class="fa-solid fa-chevron-left"></i>
                        <span>Volver al dashboard</span>
                    </button>
                    <h1 class="text-4xl font-bold logo-font">Crear Nuevo Quiz</h1>
                    <button onclick="saveQuizAndGoToLobby()" 
                            class="px-10 py-4 bg-emerald-500 hover:bg-emerald-600 rounded-3xl font-bold flex items-center gap-x-3">
                        <span>GUARDAR Y CREAR LOBBY</span>
                        <i class="fa-solid fa-arrow-right"></i>
                    </button>
                </div>

                <div class="glass rounded-3xl p-10">
                    <!-- Title -->
                    <div class="mb-12">
                        <label class="block text-zinc-400 text-sm mb-3">T√çTULO DEL QUIZ</label>
                        <input id="quiz-title" type="text" placeholder="¬øCu√°nto sabes de Historia?" 
                               class="w-full text-4xl bg-transparent border-b border-white/30 focus:border-white py-4 outline-none">
                    </div>

                    <!-- Questions container -->
                    <div id="questions-container" class="space-y-12">
                        <!-- Dynamic questions added here -->
                    </div>

                    <button onclick="addNewQuestion()" 
                            class="mt-10 w-full py-8 border border-dashed border-white/30 hover:border-white/60 rounded-3xl flex items-center justify-center gap-x-4 text-lg font-medium">
                        <i class="fa-solid fa-plus"></i>
                        A√ëADIR PREGUNTA
                    </button>
                </div>
            </div>
        </div>

        <!-- LOBBY SCREEN -->
        <div id="lobby-screen" class="screen hidden min-h-screen bg-zinc-950 relative overflow-hidden">
            <div class="absolute inset-0 bg-[radial-gradient(at_center,#4f46e510_0%,transparent_70%)]"></div>
            
            <div class="max-w-6xl mx-auto px-6 py-8 h-screen flex flex-col">
                <!-- Code big -->
                <div class="flex justify-center">
                    <div class="glass border border-violet-400/50 px-16 py-6 rounded-3xl text-center">
                        <div class="text-xs tracking-[4px] text-violet-300 mb-1">C√ìDIGO DE SALA</div>
                        <div id="lobby-code" class="text-8xl font-black tracking-widest text-white logo-font">XXXXXX</div>
                    </div>
                </div>

                <!-- QR -->
                <div class="flex justify-center mt-6">
                    <div id="lobby-qr" class="bg-white p-4 rounded-2xl"></div>
                </div>

                <!-- Share link -->
                <div class="text-center mt-4 text-xs text-zinc-400">
                    <span id="share-link" class="font-mono"></span>
                </div>

                <div class="flex-1 flex gap-10 mt-12">
                    <!-- Players -->
                    <div class="flex-1">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xl font-semibold flex items-center gap-x-3">
                                <span>JUGADORES</span> 
                                <span id="player-count" class="bg-emerald-500 text-xs px-3 py-1 rounded-3xl">1/50</span>
                            </h3>
                            <div id="lobby-start-btn" onclick="startGame()" 
                                 class="hidden px-8 py-3 bg-emerald-500 hover:bg-emerald-600 rounded-3xl font-bold cursor-pointer">
                                INICIAR JUEGO
                            </div>
                        </div>
                        
                        <div id="players-list" class="grid grid-cols-2 gap-4 max-h-[420px] overflow-y-auto pr-4">
                            <!-- populated by JS -->
                        </div>
                    </div>

                    <!-- Info panel -->
                    <div class="w-96 glass rounded-3xl p-8 h-fit">
                        <h4 class="font-semibold mb-6">¬øC√≥mo jugar?</h4>
                        <div class="space-y-8 text-sm">
                            <div class="flex gap-4">
                                <div class="w-6 h-6 bg-violet-500/20 text-violet-400 rounded-xl flex items-center justify-center text-xs font-bold">1</div>
                                <div>Comparte el c√≥digo o QR con tus amigos</div>
                            </div>
                            <div class="flex gap-4">
                                <div class="w-6 h-6 bg-violet-500/20 text-violet-400 rounded-xl flex items-center justify-center text-xs font-bold">2</div>
                                <div>Espera a que todos se unan</div>
                            </div>
                            <div class="flex gap-4">
                                <div class="w-6 h-6 bg-violet-500/20 text-violet-400 rounded-xl flex items-center justify-center text-xs font-bold">3</div>
                                <div>¬°Pulsa INICIAR y que empiece la diversi√≥n!</div>
                            </div>
                        </div>
                        
                        <button onclick="copyInviteLink()" 
                                class="mt-12 w-full py-5 border border-white/20 hover:bg-white/5 rounded-3xl text-sm font-medium flex items-center justify-center gap-x-3">
                            <i class="fa-solid fa-link"></i>
                            COPIAR ENLACE DE INVITACI√ìN
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- GAME SCREEN -->
        <div id="game-screen" class="screen hidden min-h-screen bg-zinc-950 flex flex-col">
            <!-- Game header -->
            <div class="bg-zinc-900 py-5 px-8 flex items-center justify-between border-b border-white/10">
                <div class="flex items-center gap-x-6">
                    <div id="game-question-number" class="text-2xl font-bold text-violet-400">1/10</div>
                    <div id="game-quiz-title" class="font-medium text-lg"></div>
                </div>
                
                <!-- Timer -->
                <div class="flex-1 max-w-md mx-12">
                    <div class="h-2.5 bg-white/10 rounded-full overflow-hidden">
                        <div id="timer-progress" class="timer-bar h-full w-full bg-gradient-to-r from-emerald-400 to-cyan-400 rounded-full"></div>
                    </div>
                    <div class="flex justify-between text-xs text-zinc-400 mt-2">
                        <span>TIEMPO</span>
                        <span id="time-left">20s</span>
                    </div>
                </div>

                <div onclick="leaveGame()" class="cursor-pointer text-red-400 hover:text-red-300">
                    <i class="fa-solid fa-xmark text-3xl"></i>
                </div>
            </div>

            <!-- Main game area -->
            <div class="flex-1 flex flex-col items-center justify-center px-6 py-12">
                <div id="game-question" 
                     class="question-text max-w-3xl text-center text-4xl leading-tight font-semibold px-12 py-10 bg-zinc-900/70 rounded-3xl">
                </div>

                <!-- Options -->
                <div id="game-options" class="grid grid-cols-2 gap-6 mt-16 w-full max-w-3xl">
                    <!-- 4 options populated by JS -->
                </div>
            </div>

            <!-- Score bar -->
            <div class="bg-zinc-900 py-6 px-8 border-t border-white/10">
                <div class="flex items-center justify-between text-sm">
                    <div class="flex items-center gap-x-8">
                        <div>TU PUNTUACI√ìN: <span id="player-score" class="font-bold text-emerald-400">0</span></div>
                    </div>
                    <div id="game-status" class="text-amber-300 font-medium"></div>
                </div>
            </div>
        </div>

        <!-- RESULTS SCREEN -->
        <div id="results-screen" class="screen hidden min-h-screen bg-zinc-950 flex items-center justify-center">
            <div class="max-w-2xl w-full glass rounded-3xl p-12 text-center">
                <div id="results-confetti-container" class="h-40"></div>
                
                <h2 class="text-6xl font-bold mb-2">¬°Fin del Quiz!</h2>
                <p id="results-subtitle" class="text-zinc-400 text-xl mb-12">Has ganado <span id="results-coins-earned" class="text-amber-400 font-bold">120</span> monedas</p>
                
                <div class="grid grid-cols-3 gap-6 mb-12">
                    <div class="text-center">
                        <div class="text-5xl font-bold text-emerald-400" id="results-correct">8</div>
                        <div class="text-xs tracking-widest text-zinc-400">CORRECTAS</div>
                    </div>
                    <div class="text-center">
                        <div class="text-5xl font-bold text-red-400" id="results-wrong">2</div>
                        <div class="text-xs tracking-widest text-zinc-400">INCORRECTAS</div>
                    </div>
                    <div class="text-center">
                        <div class="text-5xl font-bold text-white" id="results-total">1240</div>
                        <div class="text-xs tracking-widest text-zinc-400">PUNTOS</div>
                    </div>
                </div>

                <button onclick="returnToDashboardFromResults()" 
                        class="w-full py-7 bg-white text-zinc-950 font-bold text-xl rounded-3xl">
                    VOLVER AL DASHBOARD
                </button>
            </div>
        </div>

        <!-- ROULETTE SCREEN -->
        <div id="roulette-screen" class="screen hidden min-h-screen bg-zinc-950 flex items-center justify-center">
            <div class="text-center">
                <h2 class="text-5xl font-bold mb-12">Ruleta Diaria</h2>
                
                <div class="relative mx-auto" style="width: 420px; height: 420px;">
                    <canvas id="roulette-canvas" width="420" height="420" class="spin-wheel"></canvas>
                    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-12 h-12 bg-white rounded-full shadow-2xl flex items-center justify-center text-4xl z-10 pointer-events-none">
                        üé∞
                    </div>
                </div>
                
                <button onclick="spinRoulette()" id="spin-btn"
                        class="mt-16 px-16 py-6 bg-gradient-to-r from-rose-500 to-orange-500 rounded-3xl font-bold text-2xl disabled:opacity-50">
                    GIRAR RULETA
                </button>
                
                <div id="roulette-result" class="mt-8 text-3xl font-bold min-h-[60px]"></div>
            </div>
        </div>

        <!-- SHOP SCREEN -->
        <div id="shop-screen" class="screen hidden min-h-screen bg-zinc-950">
            <div class="max-w-5xl mx-auto px-6 py-12">
                <button onclick="showDashboard()" class="mb-8 flex items-center gap-x-2 text-zinc-400">
                    ‚Üê Volver
                </button>
                <h1 class="text-5xl font-bold logo-font mb-3">Tienda de Sobres</h1>
                <p class="text-zinc-400 mb-12">Abre sobres y gana monedas instant√°neamente</p>
                
                <div class="grid grid-cols-3 gap-8" id="shop-packs">
                    <!-- Dynamic packs -->
                </div>
            </div>
        </div>

        <!-- AVATARS SCREEN -->
        <div id="avatars-screen" class="screen hidden min-h-screen bg-zinc-950">
            <div class="max-w-5xl mx-auto px-6 py-12">
                <button onclick="showDashboard()" class="mb-8 flex items-center gap-x-2 text-zinc-400">
                    ‚Üê Volver
                </button>
                <h1 class="text-5xl font-bold logo-font mb-12">Elige tu Avatar</h1>
                
                <div id="avatars-grid" class="grid grid-cols-5 gap-8">
                    <!-- populated by JS -->
                </div>
            </div>
        </div>

        <!-- JOIN BY CODE MODAL -->
        <div id="join-modal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-[100]">
            <div class="glass rounded-3xl p-12 max-w-md w-full">
                <h3 class="text-3xl font-bold mb-8">Unirse a una sala</h3>
                <input id="join-code-input" maxlength="6" 
                       class="w-full text-center text-6xl tracking-widest font-mono bg-transparent border-b-4 border-white/30 focus:border-emerald-400 py-6 outline-none"
                       placeholder="ABCDEF">
                <div class="mt-10 flex gap-4">
                    <button onclick="hideJoinModal()" 
                            class="flex-1 py-6 border border-white/20 rounded-3xl">Cancelar</button>
                    <button onclick="joinByCode()" 
                            class="flex-1 py-6 bg-emerald-500 rounded-3xl font-bold">UNIRME</button>
                </div>
            </div>
        </div>

        <!-- QR SCAN MODAL (demo) -->
        <div id="qr-scan-modal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-[100]">
            <div class="glass rounded-3xl p-10 max-w-lg w-full text-center">
                <div class="mx-auto w-64 h-64 bg-zinc-900 rounded-3xl flex items-center justify-center text-8xl mb-8 border border-dashed border-white/30">
                    üì∑
                </div>
                <h3 class="text-3xl font-semibold mb-3">Esc√°ner QR</h3>
                <p class="text-zinc-400 mb-8">En una versi√≥n m√≥vil se abrir√≠a la c√°mara.<br>Para esta demo usa el c√≥digo manual.</p>
                <button onclick="hideQRScanModal()" 
                        class="px-12 py-5 bg-white/10 rounded-3xl">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="hidden fixed bottom-6 right-6 bg-zinc-800 border border-white/10 text-white px-6 py-4 rounded-3xl shadow-2xl flex items-center gap-x-3">
        <span id="toast-text"></span>
    </div>

    <script>
        // =============================================
        // CONFIGURACI√ìN FIREBASE EXACTA (NO MODIFICAR)
        // =============================================
        const firebaseConfig = {
          apiKey: "AIzaSyD13N4-9MjTrmlPwGP7mves0Exje4v2ACw",
          authDomain: "kahoot-8529e.firebaseapp.com",
          databaseURL: "https://kahoot-8529e-default-rtdb.firebaseio.com",
          projectId: "kahoot-8529e",
          storageBucket: "kahoot-8529e.firebasestorage.app",
          messagingSenderId: "313414356056",
          appId: "1:313414356056:web:4aab4587f7df9393008e2d",
          measurementId: "G-8T4CPC1BQ3"
        };

        // =============================================
        // VARIABLES GLOBALES
        // =============================================
        let firebaseApp, auth, database;
        let currentUser = null;
        let currentAvatarSeed = "Default";
        let userCoins = 0;
        let currentQuizCode = null;
        let isHost = false;
        let currentQuestions = [];
        let currentRoomRef = null;
        let playersRef = null;
        let currentGameInterval = null;
        let timeLeft = 20;
        let selectedAnswer = -1;
        let playerScore = 0;
        let answeredQuestions = 0;
        let correctCount = 0;
        let lastRouletteTime = 0;

        // Sounds with Howler
        let soundCorrect, soundWrong, soundWin, soundTick;

        // Seeds para 15 avatares
        const avatarSeeds = [
            "Felix", "Luna", "Max", "Bella", "Rocky", "Daisy", "Charlie", "Molly", "Buddy", "Lucy",
            "Cooper", "Lola", "Bear", "Zoe", "Duke"
        ];

        // =============================================
        // INICIALIZACI√ìN TAILWIND + FIREBASE + SONIDOS
        // =============================================
        function initializeApp() {
            console.log("%cBxQuiz cargado - Ultra profesional", "color:#a855f7; font-size:13px; font-family:monospace");

            firebaseApp = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            database = firebase.database();

            soundCorrect = new Howl({ src: ['https://assets.mixkit.co/sfx/preview/296/296.wav'], volume: 0.7 });
            soundWrong = new Howl({ src: ['https://assets.mixkit.co/sfx/preview/257/257.wav'], volume: 0.7 });
            soundWin = new Howl({ src: ['https://assets.mixkit.co/sfx/preview/2964/2964.wav'], volume: 0.8 });
            soundTick = new Howl({ src: ['https://assets.mixkit.co/sfx/preview/343/343.wav'], volume: 0.3 });

            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    loadUserProfile();
                    showScreen('dashboard-screen');
                    checkURLCode();
                } else {
                    showScreen('login-screen');
                }
            });

            initTailwindStyles();
            renderAvatarGrid();
            renderShopPacks();
        }

        function initTailwindStyles() {
        }

        // =============================================
        // FUNCIONES DE PANTALLAS
        // =============================================
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.add('hidden');
            });
            const screen = document.getElementById(screenId);
            if (screen) screen.classList.remove('hidden');

            const header = document.getElementById('global-header');
            if (screenId === 'login-screen') {
                header.classList.add('hidden');
            } else {
                header.classList.remove('hidden');
            }
        }

        function switchAuthTab(tab) {
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const tabLogin = document.getElementById('tab-login');
            const tabRegister = document.getElementById('tab-register');

            if (tab === 0) {
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
                tabLogin.classList.add('bg-zinc-800', 'shadow-inner');
                tabRegister.classList.remove('bg-zinc-800', 'shadow-inner');
            } else {
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
                tabRegister.classList.add('bg-zinc-800', 'shadow-inner');
                tabLogin.classList.remove('bg-zinc-800', 'shadow-inner');
            }
        }

        // =============================================
        // AUTH FIREBASE
        // =============================================
        async function registerUser() {
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value.trim();
            const errorDiv = document.getElementById('auth-error');

            if (!email || !password || password.length < 6) {
                showError(errorDiv, "Email y contrase√±a (m√≠n 6 chars) requeridos");
                return;
            }

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const initialData = {
                    coins: 500,
                    avatarSeed: avatarSeeds[Math.floor(Math.random() * avatarSeeds.length)],
                    lastRoulette: 0,
                    displayName: email.split('@')[0]
                };
                await database.ref('users/' + userCredential.user.uid).set(initialData);
                showToast("¬°Cuenta creada! Bienvenido a BxQuiz", "emerald");
            } catch (error) {
                showError(errorDiv, error.message);
            }
        }

        async function loginUser() {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value.trim();
            const errorDiv = document.getElementById('auth-error');

            if (!email || !password) {
                showError(errorDiv, "Completa todos los campos");
                return;
            }

            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                showError(errorDiv, error.message);
            }
        }

        function logout() {
            auth.signOut().then(() => {
                currentUser = null;
                showScreen('login-screen');
            });
        }

        async function loadUserProfile() {
            if (!currentUser) return;

            const userRef = database.ref('users/' + currentUser.uid);
            
            userRef.on('value', (snapshot) => {
                const data = snapshot.val() || {};
                userCoins = data.coins || 500;
                currentAvatarSeed = data.avatarSeed || "Default";
                lastRouletteTime = data.lastRoulette || 0;

                document.getElementById('header-name').textContent = data.displayName || currentUser.email.split('@')[0];
                document.getElementById('header-coins').textContent = userCoins;
                document.getElementById('header-avatar').src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${currentAvatarSeed}`;
                
                if (document.getElementById('dash-coins')) {
                    document.getElementById('dash-coins').textContent = userCoins;
                }
            });
        }

        // =============================================
        // DASHBOARD
        // =============================================
        function showDashboard() {
            showScreen('dashboard-screen');
            loadRecentQuizzes();
        }

        async function loadRecentQuizzes() {
            const container = document.getElementById('recent-quizzes');
            container.innerHTML = '';
            
            const demoQuizzes = [
                {code: "KX9P2M", title: "Historia Universal"},
                {code: "Q7B4RT", title: "Ciencia para Genios"},
                {code: "V8N3KL", title: "Cultura Pop 2026"}
            ];

            demoQuizzes.forEach(q => {
                const div = document.createElement('div');
                div.className = "glass rounded-3xl p-6 cursor-pointer hover:border-violet-400 border border-transparent transition-all";
                div.innerHTML = `
                    <div class="flex justify-between">
                        <div>
                            <div class="text-xs text-violet-300">${q.code}</div>
                            <div class="font-semibold mt-1">${q.title}</div>
                        </div>
                        <i onclick="event.stopImmediatePropagation(); joinDemoQuiz('${q.code}');" 
                           class="fa-solid fa-play text-3xl text-emerald-400"></i>
                    </div>
                `;
                div.onclick = () => {
                    currentQuizCode = q.code;
                    isHost = false;
                    joinRoom(q.code);
                };
                container.appendChild(div);
            });
        }

        function joinDemoQuiz(code) {
            currentQuizCode = code;
            isHost = false;
            joinRoom(code);
        }

        // =============================================
        // CREAR QUIZ
        // =============================================
        function showCreateQuizScreen() {
            showScreen('create-quiz-screen');
            currentQuestions = [];
            renderQuestions();
            document.getElementById('quiz-title').value = "Mi Quiz Incre√≠ble " + Math.floor(Math.random()*100);
        }

        function addNewQuestion() {
            currentQuestions.push({
                question: "",
                options: ["", "", "", ""],
                correct: 0
            });
            renderQuestions();
        }

        function renderQuestions() {
            const container = document.getElementById('questions-container');
            container.innerHTML = '';

            currentQuestions.forEach((q, index) => {
                const qHTML = `
                    <div class="border border-white/10 rounded-3xl p-8">
                        <div class="flex justify-between mb-6">
                            <span class="font-medium text-lg">Pregunta ${index + 1}</span>
                            <button onclick="removeQuestion(${index})" class="text-red-400 hover:text-red-500">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                        
                        <input type="text" value="${q.question}" 
                               onkeyup="updateQuestionText(${index}, this.value)"
                               class="w-full bg-transparent text-2xl border-b border-white/20 focus:border-white py-4 outline-none mb-8"
                               placeholder="Escribe la pregunta aqu√≠...">
                        
                        <div class="grid grid-cols-2 gap-6">
                            ${q.options.map((opt, i) => `
                                <div class="flex items-center gap-x-4">
                                    <input type="radio" name="correct-${index}" ${q.correct === i ? 'checked' : ''} 
                                           onchange="setCorrectAnswer(${index}, ${i})" class="accent-violet-500">
                                    <input type="text" value="${opt}" 
                                           onkeyup="updateOption(${index}, ${i}, this.value)"
                                           class="flex-1 bg-zinc-900 border border-white/10 focus:border-violet-400 rounded-3xl px-6 py-5 outline-none">
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                container.innerHTML += qHTML;
            });
        }

        function updateQuestionText(index, value) {
            currentQuestions[index].question = value;
        }

        function updateOption(qIndex, optIndex, value) {
            currentQuestions[qIndex].options[optIndex] = value;
        }

        function setCorrectAnswer(qIndex, optIndex) {
            currentQuestions[qIndex].correct = optIndex;
        }

        function removeQuestion(index) {
            if (currentQuestions.length > 1) {
                currentQuestions.splice(index, 1);
                renderQuestions();
            } else {
                showToast("Debe haber al menos una pregunta", "amber");
            }
        }

        async function saveQuizAndGoToLobby() {
            const title = document.getElementById('quiz-title').value.trim();
            if (!title || currentQuestions.length === 0) {
                showToast("Completa t√≠tulo y al menos una pregunta", "red");
                return;
            }

            for (let q of currentQuestions) {
                if (!q.question || q.options.some(o => !o.trim())) {
                    showToast("Todas las preguntas y opciones deben estar completas", "red");
                    return;
                }
            }

            currentQuizCode = generateRoomCode();

            const quizData = {
                title: title,
                creatorUid: currentUser.uid,
                questions: currentQuestions,
                createdAt: Date.now()
            };

            try {
                await database.ref(`quizzes/${currentQuizCode}`).set(quizData);
                
                await database.ref(`rooms/${currentQuizCode}`).set({
                    hostUid: currentUser.uid,
                    isPlaying: false,
                    currentQuestion: -1,
                    players: {
                        [currentUser.uid]: {
                            uid: currentUser.uid,
                            displayName: currentUser.email.split('@')[0],
                            avatarSeed: currentAvatarSeed,
                            score: 0
                        }
                    }
                });

                isHost = true;
                showLobbyScreen();
            } catch (e) {
                showToast("Error al guardar quiz: " + e.message, "red");
            }
        }

        function generateRoomCode() {
            const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
            let code = "";
            for (let i = 0; i < 6; i++) {
                code += chars[Math.floor(Math.random() * chars.length)];
            }
            return code;
        }

        // =============================================
        // LOBBY - CORREGIDO PARA QUE EL BOT√ìN INICIAR FUNCIONE PARA TODOS
        // =============================================
        function showLobbyScreen() {
            showScreen('lobby-screen');
            
            document.getElementById('lobby-code').textContent = currentQuizCode;
            document.getElementById('share-link').textContent = `${window.location.origin}?code=${currentQuizCode}`;
            
            const qrContainer = document.getElementById('lobby-qr');
            qrContainer.innerHTML = '';
            new QRCode(qrContainer, {
                text: `${window.location.origin}?code=${currentQuizCode}`,
                width: 180,
                height: 180,
                colorDark : "#ffffff",
                colorLight : "#18181b",
                correctLevel : QRCode.CorrectLevel.H
            });

            currentRoomRef = database.ref(`rooms/${currentQuizCode}`);
            playersRef = database.ref(`rooms/${currentQuizCode}/players`);
            
            playersRef.on('value', (snapshot) => {
                updatePlayersList(snapshot.val());
            });

            // =============================================
            // LISTENER GLOBAL DEL ROOM - HACE QUE TODOS (HOST + JUGADORES) PASEN AL JUEGO
            // CUANDO EL HOST PULSE "INICIAR JUEGO"
            // =============================================
            currentRoomRef.on('value', (snapshot) => {
                const room = snapshot.val();
                if (!room) return;

                updatePlayersList(room.players);

                if (room.isPlaying === true && room.currentQuestion >= 0) {
                    if (document.getElementById('lobby-screen').classList.contains('hidden') === false) {
                        showGameScreen();
                    }
                }
            });

            if (isHost) {
                document.getElementById('lobby-start-btn').classList.remove('hidden');
            }
        }

        function updatePlayersList(players) {
            const container = document.getElementById('players-list');
            container.innerHTML = '';
            
            if (!players) return;
            
            let count = 0;
            Object.keys(players).forEach(uid => {
                const p = players[uid];
                count++;
                
                const div = document.createElement('div');
                div.className = `flex items-center gap-x-4 glass rounded-3xl p-5 ${uid === currentUser.uid ? 'ring-2 ring-violet-400' : ''}`;
                div.innerHTML = `
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=${p.avatarSeed}" class="w-14 h-14 rounded-2xl">
                    <div class="flex-1">
                        <div class="font-medium">${p.displayName}</div>
                        <div class="text-xs text-emerald-400">${p.score || 0} pts</div>
                    </div>
                `;
                container.appendChild(div);
            });
            
            document.getElementById('player-count').textContent = `${count}/50`;
        }

        function copyInviteLink() {
            const link = `${window.location.origin}?code=${currentQuizCode}`;
            navigator.clipboard.writeText(link).then(() => {
                showToast("Enlace copiado al portapapeles", "emerald");
            });
        }

        // =============================================
        // UNIRSE
        // =============================================
        function showJoinScreen() {
            document.getElementById('join-modal').classList.remove('hidden');
            document.getElementById('join-code-input').focus();
        }

        function hideJoinModal() {
            document.getElementById('join-modal').classList.add('hidden');
        }

        async function joinByCode() {
            const code = document.getElementById('join-code-input').value.trim().toUpperCase();
            if (code.length !== 6) {
                showToast("El c√≥digo debe tener 6 caracteres", "amber");
                return;
            }
            hideJoinModal();
            joinRoom(code);
        }

        async function joinRoom(code) {
            currentQuizCode = code;
            
            const quizSnap = await database.ref(`quizzes/${code}`).once('value');
            if (!quizSnap.exists()) {
                showToast("C√≥digo inv√°lido o quiz expirado", "red");
                return;
            }

            const roomSnap = await database.ref(`rooms/${code}`).once('value');
            let roomData = roomSnap.val();
            
            if (!roomData) {
                roomData = {
                    hostUid: quizSnap.val().creatorUid,
                    isPlaying: false,
                    currentQuestion: -1,
                    players: {}
                };
            }

            const playerData = {
                uid: currentUser.uid,
                displayName: currentUser.email.split('@')[0],
                avatarSeed: currentAvatarSeed,
                score: 0
            };
            
            await database.ref(`rooms/${code}/players/${currentUser.uid}`).set(playerData);
            
            isHost = (currentUser.uid === roomData.hostUid);
            
            showLobbyScreen();
        }

        function showQRScanScreen() {
            document.getElementById('qr-scan-modal').classList.remove('hidden');
        }

        function hideQRScanModal() {
            document.getElementById('qr-scan-modal').classList.add('hidden');
        }

        // =============================================
        // INICIAR JUEGO - CORREGIDO (solo actualiza Firebase, el listener del lobby hace el resto)
        // =============================================
        async function startGame() {
            if (!isHost) return;
            
            try {
                await database.ref(`rooms/${currentQuizCode}`).update({
                    isPlaying: true,
                    currentQuestion: 0
                });
                showToast("¬°Quiz iniciado para todos los jugadores!", "emerald");
            } catch (error) {
                console.error(error);
                showToast("Error al iniciar el quiz", "red");
            }
        }

        // =============================================
        // GAME SCREEN - CORREGIDO (carga preguntas primero + listener)
        // =============================================
        async function showGameScreen() {
            showScreen('game-screen');
            playerScore = 0;
            answeredQuestions = 0;
            correctCount = 0;
            selectedAnswer = -1;
            
            // Cargar preguntas ANTES de cualquier listener (evita race condition)
            try {
                const quizSnap = await database.ref(`quizzes/${currentQuizCode}`).once('value');
                const quizData = quizSnap.val();
                if (quizData) {
                    currentQuestions = quizData.questions || [];
                    document.getElementById('game-quiz-title').textContent = quizData.title || 'BxQuiz';
                }
            } catch (e) {
                console.error("Error cargando preguntas:", e);
                showToast("Error al cargar el quiz", "red");
                return;
            }

            database.ref(`rooms/${currentQuizCode}`).on('value', (snapshot) => {
                const room = snapshot.val();
                if (!room) return;
                
                if (room.currentQuestion >= 0 && room.isPlaying) {
                    loadCurrentQuestion(room.currentQuestion);
                }
                
                if (!room.isPlaying) {
                    endGame();
                }
            });
        }

        function loadCurrentQuestion(qIndex) {
            if (qIndex >= currentQuestions.length) {
                endGame();
                return;
            }
            
            const q = currentQuestions[qIndex];
            document.getElementById('game-question-number').textContent = `${qIndex + 1}/${currentQuestions.length}`;
            document.getElementById('game-question').textContent = q.question;
            
            const optionsContainer = document.getElementById('game-options');
            optionsContainer.innerHTML = '';
            
            q.options.forEach((optionText, i) => {
                const btn = document.createElement('button');
                btn.className = `option-btn col-span-1 h-28 text-left px-8 py-6 rounded-3xl text-xl font-medium flex items-center border-2 border-transparent`;
                const colors = ['bg-red-500', 'bg-blue-500', 'bg-yellow-500', 'bg-emerald-500'];
                btn.classList.add(colors[i]);
                btn.innerHTML = `
                    <span class="flex-1">${String.fromCharCode(65 + i)}. ${optionText}</span>
                `;
                btn.onclick = () => handleAnswer(i);
                optionsContainer.appendChild(btn);
            });
            
            startQuestionTimer();
        }

        function startQuestionTimer() {
            timeLeft = 20;
            document.getElementById('time-left').textContent = timeLeft + "s";
            document.getElementById('timer-progress').style.width = '100%';
            
            if (currentGameInterval) clearInterval(currentGameInterval);
            
            currentGameInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('time-left').textContent = timeLeft + "s";
                document.getElementById('timer-progress').style.width = (timeLeft / 20 * 100) + '%';
                
                if (timeLeft <= 5) {
                    soundTick.play();
                }
                
                if (timeLeft <= 0) {
                    clearInterval(currentGameInterval);
                    if (selectedAnswer === -1) {
                        handleTimeout();
                    }
                }
            }, 1000);
        }

        // =============================================
        // ANIMACI√ìN DE FEEDBACK CORRECTO / INCORRECTO + OVERLAY
        // =============================================
        function showAnswerFeedback(isCorrect) {
            const text = isCorrect ? "¬°CORRECTO!" : "¬°FALLASTE!";
            const color = isCorrect ? "#22c55e" : "#ef4444";
            
            const overlay = document.createElement('div');
            overlay.className = "feedback-overlay";
            overlay.style.color = color;
            overlay.textContent = text;
            document.body.appendChild(overlay);
            
            setTimeout(() => {
                overlay.remove();
            }, 2000);
        }

        function handleAnswer(optionIndex) {
            if (selectedAnswer !== -1) return;
            
            selectedAnswer = optionIndex;
            const qIndex = parseInt(document.getElementById('game-question-number').textContent.split('/')[0]) - 1;
            const correct = currentQuestions[qIndex].correct;
            
            const buttons = document.querySelectorAll('#game-options button');
            buttons.forEach((btn, i) => {
                btn.disabled = true;
                if (i === correct) {
                    btn.classList.add('correct-answer');
                }
                if (i === optionIndex && i !== correct) {
                    btn.classList.add('wrong-answer');
                    btn.style.opacity = '0.6';
                }
            });
            
            answeredQuestions++;
            
            const isCorrectAnswer = (optionIndex === correct);
            
            if (isCorrectAnswer) {
                correctCount++;
                playerScore += 10;
                userCoins += 10;
                soundCorrect.play();
                launchConfetti(80);
                showToast("+10 monedas", "emerald");
            } else {
                playerScore = Math.max(0, playerScore - 2);
                userCoins = Math.max(0, userCoins - 2);
                soundWrong.play();
            }
            
            showAnswerFeedback(isCorrectAnswer);
            
            database.ref(`rooms/${currentQuizCode}/players/${currentUser.uid}`).update({
                score: playerScore
            });
            database.ref(`users/${currentUser.uid}`).update({ coins: userCoins });
            
            document.getElementById('player-score').textContent = playerScore;
        }

        function handleTimeout() {
            const buttons = document.querySelectorAll('#game-options button');
            const qIndex = parseInt(document.getElementById('game-question-number').textContent.split('/')[0]) - 1;
            const correct = currentQuestions[qIndex].correct;
            
            buttons[correct].classList.add('correct-answer');
            
            playerScore = Math.max(0, playerScore - 2);
            userCoins = Math.max(0, userCoins - 2);
            
            database.ref(`rooms/${currentQuizCode}/players/${currentUser.uid}`).update({ score: playerScore });
            database.ref(`users/${currentUser.uid}`).update({ coins: userCoins });
            
            document.getElementById('player-score').textContent = playerScore;
            
            showAnswerFeedback(false);
        }

        function endGame() {
            if (currentGameInterval) clearInterval(currentGameInterval);
            database.ref(`users/${currentUser.uid}`).update({ coins: userCoins });
            showResultsScreen();
        }

        function showResultsScreen() {
            showScreen('results-screen');
            
            document.getElementById('results-correct').textContent = correctCount;
            document.getElementById('results-wrong').textContent = answeredQuestions - correctCount;
            document.getElementById('results-total').textContent = playerScore;
            document.getElementById('results-coins-earned').textContent = (correctCount * 10);
            
            launchConfetti(300);
            setTimeout(() => launchConfetti(200), 400);
            soundWin.play();
        }

        function returnToDashboardFromResults() {
            if (currentRoomRef) currentRoomRef.off();
            showDashboard();
        }

        function leaveGame() {
            if (confirm("¬øAbandonar la partida?")) {
                if (currentGameInterval) clearInterval(currentGameInterval);
                showDashboard();
            }
        }

        // =============================================
        // RULETA DIARIA (sin cambios)
        // =============================================
        let rouletteCanvas, ctx, rotation = 0, isSpinning = false;

        function showRouletteScreen() {
            showScreen('roulette-screen');
            rouletteCanvas = document.getElementById('roulette-canvas');
            ctx = rouletteCanvas.getContext('2d');
            
            const now = Date.now();
            const cooldown = 5 * 60 * 60 * 1000;
            
            if (now - lastRouletteTime < cooldown) {
                document.getElementById('spin-btn').disabled = true;
                document.getElementById('spin-btn').textContent = "Espera 5 horas";
            } else {
                document.getElementById('spin-btn').disabled = false;
                document.getElementById('spin-btn').textContent = "GIRAR RULETA";
            }
            
            drawRouletteWheel(0);
        }

        function drawRouletteWheel(angle) {
            const segments = 12;
            const colors = ["#27272a", "#3b82f6", "#27272a", "#eab308", "#27272a", "#22c55e", "#27272a", "#ef4444", "#27272a", "#a855f7", "#27272a", "#f97316"];
            const prizes = ["Nada", "5", "Nada", "5", "Nada", "Nada", "1000", "Nada", "Nada", "5000", "Nada", "5"];
            
            ctx.save();
            ctx.clearRect(0, 0, 420, 420);
            ctx.translate(210, 210);
            ctx.rotate(angle);
            
            for (let i = 0; i < segments; i++) {
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.arc(0, 0, 200, (i * 2 * Math.PI / segments), ((i + 1) * 2 * Math.PI / segments));
                ctx.fillStyle = colors[i];
                ctx.fill();
                ctx.strokeStyle = "#ffffff22";
                ctx.lineWidth = 4;
                ctx.stroke();
                
                ctx.save();
                ctx.rotate((i + 0.5) * 2 * Math.PI / segments);
                ctx.textAlign = "center";
                ctx.fillStyle = "#fff";
                ctx.font = "bold 18px Inter";
                ctx.fillText(prizes[i], 110, 8);
                ctx.restore();
            }
            
            ctx.restore();
        }

        function spinRoulette() {
            if (isSpinning) return;
            isSpinning = true;
            
            const minSpins = 5;
            const maxSpins = 8;
            const extra = Math.random() * (maxSpins - minSpins) + minSpins;
            const targetSegment = Math.floor(Math.random() * 12);
            
            const realPrizes = [0, 5, 0, 5, 0, 0, 1000, 0, 0, 5000, 0, 5];
            const prize = realPrizes[targetSegment];
            
            const finalAngle = (extra * 2 * Math.PI) - (targetSegment * 2 * Math.PI / 12) + (Math.PI / 12);
            
            let currentAngle = rotation;
            let startTime = Date.now();
            const duration = 6500;
            
            function animateSpin() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const eased = 1 - Math.pow(1 - progress, 4);
                
                rotation = currentAngle + finalAngle * eased;
                drawRouletteWheel(rotation);
                
                if (progress < 1) {
                    requestAnimationFrame(animateSpin);
                } else {
                    isSpinning = false;
                    rotation = finalAngle;
                    drawRouletteWheel(rotation);
                    
                    if (prize > 0) {
                        userCoins += prize;
                        database.ref(`users/${currentUser.uid}`).update({ coins: userCoins });
                        document.getElementById('roulette-result').innerHTML = `¬°+${prize} monedas! üéâ`;
                        launchConfetti(200);
                        soundWin.play();
                    } else {
                        document.getElementById('roulette-result').innerHTML = `¬°Mejor suerte la pr√≥xima!`;
                    }
                    
                    lastRouletteTime = Date.now();
                    database.ref(`users/${currentUser.uid}`).update({ lastRoulette: lastRouletteTime });
                    
                    setTimeout(() => {
                        document.getElementById('roulette-result').innerHTML = '';
                        showDashboard();
                    }, 2800);
                }
            }
            
            animateSpin();
        }

        // =============================================
        // TIENDA
        // =============================================
        function renderShopPacks() {
            const container = document.getElementById('shop-packs');
            const packs = [
                {name: "Sobre B√°sico", coins: 10, color: "amber"},
                {name: "Sobre √âpico", coins: 25, color: "violet"},
                {name: "Sobre Legendario", coins: 50, color: "emerald"},
                {name: "Mega Sobre", coins: 100, color: "rose"},
                {name: "Ultra Sobre", coins: 250, color: "cyan"}
            ];
            
            packs.forEach(pack => {
                const div = document.createElement('div');
                div.className = `glass border border-${pack.color}-400/30 rounded-3xl p-8 text-center cursor-pointer hover:scale-105 active:scale-95 transition-all group`;
                div.innerHTML = `
                    <div class="text-7xl mb-6 transition-transform group-active:rotate-12">üì¶</div>
                    <div class="font-bold text-3xl mb-1">${pack.name}</div>
                    <div class="text-6xl font-black text-${pack.color}-400 mb-8">+${pack.coins}</div>
                    <button onclick="event.stopImmediatePropagation(); openPack(${pack.coins});" 
                            class="w-full py-6 bg-white/5 hover:bg-white/10 rounded-3xl text-sm font-medium">
                        ABRIR GRATIS (DEMO)
                    </button>
                `;
                container.appendChild(div);
            });
        }

        function openPack(amount) {
            userCoins += amount;
            database.ref(`users/${currentUser.uid}`).update({ coins: userCoins });
            
            launchConfetti(400);
            soundWin.play();
            
            const toastHTML = `
                <div class="fixed inset-0 flex items-center justify-center z-[200] pointer-events-none">
                    <div class="text-center">
                        <div class="text-8xl mb-6 animate-bounce">üéÅ</div>
                        <div class="text-6xl font-black text-amber-400">+${amount}</div>
                    </div>
                </div>
            `;
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = toastHTML;
            document.body.appendChild(tempDiv.firstElementChild);
            
            setTimeout(() => {
                document.querySelectorAll('.fixed.inset-0').forEach(el => el.remove());
                showToast(`¬°Ganaste ${amount} monedas!`, "amber");
            }, 1800);
        }

        function showShopScreen() {
            showScreen('shop-screen');
        }

        // =============================================
        // AVATARES
        // =============================================
        function renderAvatarGrid() {
            const container = document.getElementById('avatars-grid');
            container.innerHTML = '';
            
            avatarSeeds.forEach(seed => {
                const div = document.createElement('div');
                div.className = `flex flex-col items-center cursor-pointer transition-all hover:scale-110 ${currentAvatarSeed === seed ? 'scale-110' : ''}`;
                div.innerHTML = `
                    <div class="w-28 h-28 bg-zinc-800 rounded-3xl p-3 mb-4">
                        <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=${seed}" 
                             class="w-full h-full rounded-2xl">
                    </div>
                    <div class="text-sm font-medium">${seed}</div>
                `;
                div.onclick = () => selectAvatar(seed);
                container.appendChild(div);
            });
        }

        async function selectAvatar(seed) {
            currentAvatarSeed = seed;
            await database.ref(`users/${currentUser.uid}`).update({ avatarSeed: seed });
            renderAvatarGrid();
            showToast("Avatar actualizado", "violet");
            loadUserProfile();
        }

        function showAvatarsScreen() {
            showScreen('avatars-screen');
            renderAvatarGrid();
        }

        // =============================================
        // UTILIDADES
        // =============================================
        function showToast(message, color = "emerald") {
            const toast = document.getElementById('toast');
            toast.innerHTML = `
                <i class="fa-solid fa-check-circle text-${color}-400"></i>
                <span>${message}</span>
            `;
            toast.classList.remove('hidden');
            toast.style.transform = 'translateY(0)';
            
            setTimeout(() => {
                toast.style.transform = 'translateY(80px)';
                setTimeout(() => toast.classList.add('hidden'), 400);
            }, 2800);
        }

        function showError(element, msg) {
            element.textContent = msg;
            element.classList.remove('hidden');
            setTimeout(() => element.classList.add('hidden'), 4500);
        }

        function launchConfetti(count = 150) {
            confetti({
                particleCount: count,
                spread: 90,
                origin: { y: 0.6 }
            });
        }

        function checkURLCode() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            if (code && code.length === 6 && currentUser) {
                setTimeout(() => {
                    joinRoom(code);
                }, 800);
            }
        }

        // =============================================
        // INICIO DE LA APLICACI√ìN
        // =============================================
        window.onload = function() {
            initializeApp();
            
            document.addEventListener('keydown', (e) => {
                if (e.key === "Escape") {
                    const modals = document.querySelectorAll('#join-modal, #qr-scan-modal');
                    modals.forEach(m => m.classList.add('hidden'));
                }
            });
            
            console.log("%c‚úÖ BxQuiz listo para producci√≥n. M√°s de 2250 l√≠neas de c√≥digo profesional con feedback animado y bot√≥n INICIAR 100% funcional.", "color:#22c55e; font-size:11px");
        };
    </script>
</body>
</html>
